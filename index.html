<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Preventivo Tesi</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
  <style>
    body { font-family:sans-serif; max-width:600px; margin:2em auto; }
    h2 { text-align:center; color:#2a4d7a; }
    .card { background:#f9f9f9; padding:20px; border-radius:8px; box-shadow:0 0 8px rgba(0,0,0,0.1); }
    .card label, .card button { display:block; width:100%; margin-bottom:1em; }
    .card input, .card select { width:100%; padding:8px; }
    .card button { background:#336699; color:#fff; border:none; border-radius:4px; cursor:pointer; }
    #progressBar { width:0; height:8px; background:#336699; transition:width .2s; }
    #progressContainer { display:none; background:#eee; border-radius:4px; overflow:hidden; margin-bottom:1em; }
    #risultato { background:#eef6ff; padding:15px; border-radius:6px; font-size:1.1em; }
  </style>
</head>
<body>
  <h2>ğŸ“ Preventivo Stampa Tesi</h2>
  <div class="card">
    <form onsubmit="return false;">
      <label>ğŸ“‚ Carica PDF:
        <input type="file" id="pdfFile" accept="application/pdf" required>
      </label>
      <label>ğŸ§® Copie:
        <input type="number" id="copie" value="1" min="1">
      </label>
      <label>ğŸ“˜ Copertina:
        <select id="copertina">
          <option value="0">Similpelle (inclusa)</option>
          <option value="5">Tela/Seta (+â‚¬5)</option>
        </select>
      </label>
      <label>ğŸ“‘ Stampa:
        <select id="frontalita">
          <option value="0.03">Solo fronte (+â‚¬0,03/pagina)</option>
          <option value="0">Fronte/Retro</option>
        </select>
      </label>
      <label>
        <input type="checkbox" id="dorso"> ğŸ·ï¸ Titolo sul dorso (+â‚¬6,50/copia)
      </label>
      <button id="btnCalc">Calcola Preventivo</button>
    </form>
    <div id="progressContainer">
      <div id="progressBar"></div>
      <div id="progressText" style="margin-top:4px; font-size:.9em;"></div>
    </div>
    <div id="risultato"></div>
  </div>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.worker.min.js';

    document.getElementById('btnCalc').onclick = async () => {
      const f = document.getElementById('pdfFile');
      if (!f.files.length) return alert('Carica un PDF.');
      document.getElementById('risultato').innerHTML = '';
      document.getElementById('progressContainer').style.display = 'block';
      updateProgress(0,1,'Avvioâ€¦');

      const buf = await f.files[0].arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
      let bn=0, col=0, tot=pdf.numPages;

      for (let i=1; i<=tot; i++) {
        const pg = await pdf.getPage(i);
        const vp = pg.getViewport({ scale:1 });
        const cnv = document.createElement('canvas');
        cnv.width = vp.width; cnv.height = vp.height;
        await pg.render({ canvasContext:cnv.getContext('2d'), viewport:vp }).promise;
        const d = cnv.getContext('2d').getImageData(0,0,cnv.width,cnv.height).data;
        let isCol=false;
        for (let p=0; p<d.length; p+=4) {
          if (d[p]!==d[p+1]||d[p+1]!==d[p+2]) { isCol=true; break; }
        }
        isCol?col++:bn++;
        updateProgress(i,tot);
      }

      // calcolo
      const copie   = +document.getElementById('copie').value;
      const copVal  = +document.getElementById('copertina').value;
      const extra   = +document.getElementById('frontalita').value;
      const dorso   = document.getElementById('dorso').checked;
      let base=35; if(copie===2)base=27.5; if(copie>=3)base=22.5;
      const costBase = base*copie;
      const costCop  = copVal*copie;
      const costBN   = bn*(0.07+extra)*copie;
      const costCol  = col*(0.50+extra)*copie;
      const costDr   = dorso?6.5*copie:0;
      const totCost  = costBase+costCop+costBN+costCol+costDr;
      const perC     = totCost/copie;

      document.getElementById('risultato').innerHTML = `
        <strong>ğŸ§¾ Riepilogo</strong><br><br>
        ğŸ“„ B/N: ${bn}<br>
        ğŸ¨ Colori: ${col}<br><br>
        ğŸ“¦ Base: â‚¬${base.toFixed(2)}Ã—${copie}=â‚¬${costBase.toFixed(2)}<br>
        ğŸ“˜ Copertina: â‚¬${copVal.toFixed(2)}Ã—${copie}=â‚¬${costCop.toFixed(2)}<br>
        ğŸ–¨ï¸ B/N: â‚¬${(0.07+extra).toFixed(2)}Ã—${bn}Ã—${copie}=â‚¬${costBN.toFixed(2)}<br>
        ğŸ¨ Colori: â‚¬${(0.50+extra).toFixed(2)}Ã—${col}Ã—${copie}=â‚¬${costCol.toFixed(2)}<br>
        ${dorso?`ğŸ·ï¸ Dorso: â‚¬6,50Ã—${copie}=â‚¬${costDr.toFixed(2)}<br>`:''}
        <br><strong>ğŸ’° Totale: â‚¬${totCost.toFixed(2)}</strong><br>
        <strong>ğŸ“Š A copia: â‚¬${perC.toFixed(2)}</strong>
      `;
      document.getElementById('progressContainer').style.display = 'none';
    };

    function updateProgress(p, t, txt) {
      const pct = Math.round((p/t)*100);
      document.getElementById('progressBar').style.width = pct + '%';
      document.getElementById('progressText').innerText = txt||`Pagina ${p} di ${t} (${pct}%)`;
    }
  </script>
</body>
</html>
